<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment VELRIDERS</title>
    <link rel="stylesheet" href="style9.css">
    <link rel="stylesheet" href="navlogin.css">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.5.0/fonts/remixicon.css" rel="stylesheet" />
    <link rel="icon" type="image/x-icon" href="image/icon1.png">
    <link rel="stylesheet" href="fimage.css">
    <link rel="stylesheet" href="linenav.css">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap');
    </style>
</head>

<body>
    <nav>
        <div class="logo">
            <a href="index.html"><img src="image1/logo.jpg" alt="Logo"></a>
        </div>
        <ul class="nav-links">
            <li><a class="line" href="index.html">Home</a></li>

            <li><a class="line" href="index7.html">About</a></li>

            <li><a class="line" href="#">Contact Us</a></li>
            <div style="background: rgba(128, 128, 128, 0.477);cursor: not-allowed;" class="location-dropdown">
                <img src="image/location.jpg" alt="location">
                <select
                    style="background:rgba(128, 128, 128, 0); cursor: not-allowed; color:rgba(52, 52, 52, 0.849);color:rgb(4, 4, 4);font-size:medium"
                    disabled>
                    <option value="ahmedabad">Ahmedabad</option>
                    <option value="jamnagar">Jamnagar</option>
                    <option value="gandhinagar">Gandhinagar</option>
                    <option value="porbandar">Porbandar</option>
                </select>
            </div>
            <a href="index4.html" id="auth-link">
                <button id="auth-btn"
                    style="background-color: #38A4A6; color: white; padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-size: 14px;">Login
                    | Sign up</button>
            </a>
            <div class="profile" id="profile-menu" style="display: none;">
                <span class="profile-name" id="profile-name">User</span>
                <img src="default-avatar.png" id="profile-img" class="profile-img" alt="Profile">
                <div class="dropdown" id="dropdown-menu">
                    <label style="background-color: #848484a4; color: white; border-radius: 5px; font-size: small;"
                        for="file-upload">Change Profile Photo</label>
                    <input type="file" id="file-upload" accept="image/*">
                    <input type="text" id="edit-name" class="edit-name" placeholder="Enter new name">
                    <button class="save-btn" id="save-name-btn">Save</button>
                    <button class="logout-btn" id="logout-btn">Logout</button>
                    <li><a style="background-color: #848484a4; color: white; border-radius: 5px;font-size: small; margin-top: 10px;text-align: center;"
                            href="booking.html">Your Booking</a></li>

                </div>
            </div>
        </ul>
        <div class="menu-icon">&#9776;</div>
    </nav>
    <div class="backbtn">
        <a href="index10.html">
            <img src="image2/Arrow - Left 2.png" alt="">Back
        </a>
    </div>

    <div class="main">
        <div class="loading" id="loading-spinner"
            style="display: flex; justify-content: center; align-items: center; height: 100%;">
            <div style="font-size: 24px; color: #38A4A6;"></div>
        </div>
        <div class="maininner" id="main-content" style="display: none;">
            <div class="periodoftime">
                <img class="img" alt="">
                <div class="info">
                    <h3></h3>
                    <div class="data">
                        <div class="left">
                            <h5 id="fromDateDisplay"></h5>
                            <p id="fromTimeDisplay"></p>
                        </div>
                        <i class="ri-arrow-right-line"></i>
                        <div class="right">
                            <h5 id="toDateDisplay"></h5>
                            <p id="toTimeDisplay"></p>
                        </div>
                    </div>
                </div>
            </div>
            <br>
            <div class="lowwer">
                <div class="btn">
                    <button>price summary</button>
                </div>
                <div class="formdata">
                    <div>Trip Amount</div>
                    <div class="trip-amount op">₹</div>
                </div>
                <div class="formdata">
                    <div>Tax Amount</div>
                    <div class="tax-amount op">₹</div>
                </div>
                <div class="formdata">
                    <div>Convenience Fee</div>
                    <div class="convenience-fee op">+₹</div>
                </div>
                <div class="formdata">
                    <div>Total Price</div>
                    <div class="total-price op">₹</div>
                </div>
                <div class="formdata">
                    <div>Final Amount</div>
                    <div style="color: rgb(24, 24, 24); font-weight: 600;" class="final-amount op">₹9005</div>
                </div>
                <div>
                    <a style="color: rgb(253, 9, 9); font-size:medium;text-decoration: none;" href="terms.html">
                        <p>Terms and Conditions</p>
                    </a>
                </div>
                <div class="lowerbtn">
                    <button id="pay-now-btn" class="pay" style="cursor: pointer; font-size: large;">Pay Now</button>
                </div>
            </div>
            <div class="footer">
                <div class="discount">
                    <img src="data:image/svg+xml,%3csvg%20width='59'%20height='59'%20viewBox='0%200%2059%2059'%20fill='none'%20xmlns='http://www.w3.org/2000/svg'%3e%3cpath%20d='M15.1344%2034.7807L12.5757%2032.222C11.5321%2031.1783%2011.5321%2029.4613%2012.5757%2028.4177L15.1344%2025.859C15.572%2025.4213%2015.9255%2024.5628%2015.9255%2023.9568V20.3376C15.9255%2018.8562%2017.1375%2017.6443%2018.6189%2017.6443H22.238C22.844%2017.6443%2023.7025%2017.2908%2024.1402%2016.8532L26.6989%2014.2945C27.7425%2013.2508%2029.4595%2013.2508%2030.5032%2014.2945L33.0619%2016.8532C33.4996%2017.2908%2034.358%2017.6443%2034.964%2017.6443H38.5832C40.0646%2017.6443%2041.2765%2018.8562%2041.2765%2020.3376V23.9568C41.2765%2024.5628%2041.63%2025.4213%2042.0677%2025.859L44.6264%2028.4177C45.6701%2029.4613%2045.6701%2031.1783%2044.6264%2032.222L42.0677%2034.7807C41.63%2035.2184%2041.2765%2036.0769%2041.2765%2036.6829V40.3019C41.2765%2041.7832%2040.0646%2042.9954%2038.5832%2042.9954H34.964C34.358%2042.9954%2033.4996%2043.3488%2033.0619%2043.7865L30.5032%2046.3452C29.4595%2047.3889%2027.7425%2047.3889%2026.6989%2046.3452L24.1402%2043.7865C23.7025%2043.3488%2022.844%2042.9954%2022.238%2042.9954H18.6189C17.1375%2042.9954%2015.9255%2041.7832%2015.9255%2040.3019V36.6829C15.9255%2036.06%2015.572%2035.2015%2015.1344%2034.7807Z'%20stroke='%2338A4A6'%20stroke-width='2.525'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M23.5664%2035.352L33.6664%2025.252'%20stroke='%2338A4A6'%20stroke-width='2.525'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M32.8168%2034.5096H32.8319'%20stroke='%2338A4A6'%20stroke-width='3.36667'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M24.3988%2026.0936H24.4139'%20stroke='%2338A4A6'%20stroke-width='3.36667'%20stroke-linecap='round'%20stroke-linejoin='round'/%3e%3cpath%20d='M58.9167%2029.4583C58.9167%2045.7277%2045.7277%2058.9167%2029.4583%2058.9167C13.1889%2058.9167%200%2045.7277%200%2029.4583C0%2013.1889%2013.1889%200%2029.4583%200C45.7277%200%2058.9167%2013.1889%2058.9167%2029.4583Z'%20fill='%2338A4A6'%20fill-opacity='0.2'/%3e%3c/svg%3e" alt="">
                    <h2>Apply Coupon code</h2>
                </div>
                <div>
                    <div class="text">
                        <input type="text" id="couponCode" style="font-size: large; padding-left: 5px;">
                        <button id="applyCoupon" style="cursor:pointer;">apply</button>
                    </div>
                </div>
                <div class="Couponcode" id="couponMessage">
                    <h2></h2>
                </div>
            </div>
        </div>
    </div>
    <br><br>
    <!-- footer -->
    <div id="upper1">
        <div class="upper">
            <div class="upperleft">
                <img src="image1/footerupperleftimg.png" alt="">
            </div>
            <div class="upperright">
                <h4>Do you want to stay updated on</h4>
                <h1 style="text-transform: lowercase;">exclusive email offers?</h1>
                <div class="searchbar">
                    <img src="image1/upperrightmailimg.png" alt="">
                    <input type="text" placeholder="Enter your email">
                    <button style="color: white; cursor: pointer;">Subscribe</button>
                </div>
            </div>
        </div>
    </div>
    <div class="murga">
        <div class="murgi">
            <div class="lower">
                <div class="p1">
                    <img src="image/footerleftlogo.svg" alt="">
                    <p>Rent your dream ride with Vel Riders – Cars and bikes for every adventure.</p>
                </div>
                <div class="p2">
                    <h2><a style="background-color: transparent; text-decoration: none;" href="">helpful link</a></h2>
                    <h5><a style="background-color: transparent; text-decoration: none;" href="index.html">Home</a></h5>
                    <h5><a style="background-color: transparent; text-decoration: none;" href="index7.html">About</a>
                    </h5>
                    <h5><a style="background-color: transparent; text-decoration: none;" href="index8.html">Contact</a>
                    </h5>
                    <h5><a style="background-color: transparent; text-decoration: none;"
                            href="Privacy-Policy.html">Privacy Policy</a></h5>
                    <h5><a style="background-color: transparent; color: white; text-decoration: none;"
                            href="terms.html">Terms & Condition</a></h5>
                </div>
                <div class="p3">
                    <h2>get in touch</h2>
                    <div class="leftfooter">
                        <img src="image1/footerlogo.png" alt="" class="img1">
                        <a href="https://www.google.com/maps/search/OFFICE+NO.+215,+Iscon+Emporio,+Satellite+Rd,+beside+Star+Bazar+BRTS+Bus+Stop,+Satellite,+Ahmedabad,+Gujarat+380015/@23.0268595,72.512787,15z/data=!3m1!4b1?entry=ttu&g_ep=EgoyMDI1MDIyNi4xIKXMDSoASAFQAw%3D%3D"
                            style="text-decoration: none;background-color: transparent;">
                            <p>SHOP NO.232, Someshwar Complex, BRTS STOP, Satellite Rd, opp. Iscon Emporio, nr Star
                                Bazaar, Satellite, Ahmedabad, Gujarat 380015</p>
                        </a>
                    </div>
                    <div class="leftfooter">
                        <img src="image1/footermail.png" alt="" class="img2">
                        <p>info@velriders.com</p>
                    </div>
                    <div class="leftfooter">
                        <img src="image/footercall2.svg" alt="" class="img3">
                        <p>082382 24282</p>
                    </div>
                </div>
            </div>
            <div class="boder">
                <div class="lastfooter">
                    <div class="lastfooterleft">
                        <a target="_blank" href="https://www.facebook.com/shaileshcarbike" style="background-color: transparent;">
                            <div class="circle">
                                <img src="image/facebookfinal.svg" alt="">
                            </div>
                        </a>
                        <a target="_blank" href="" style="background-color: transparent;">
                            <div class="circle">
                                <img src="image/twiteerfinal.svg" alt="">
                            </div>
                        </a>                        
                        <a target="_blank" href="https://www.instagram.com/velriders/" style="background-color: transparent;">
                            <div class="circle">
                                <img src="image/instagramfinal.svg" alt="">
                            </div>
                        </a>
                                
                        <a target="_blank" href="" style="background-color: transparent;">
                            <div class="circle">
                                <img src="image/instafinal.svg" alt="">
                            </div>
                        </a>
                    </div>
                    <div class="lastfooterright">
                        <p>download the app by clicking the link below: </p>
                        <div>
                            <a style="background: transparent;"
                                href="https://play.google.com/store/apps/details?id=com.imd.velriders"><img
                                    src="image/image 1.svg" alt=""></a>
                            <img src="image/image 2.svg" alt="">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }


        function formatDate(dateString) {
            const options = { weekday: 'short', year: 'numeric', month: '2-digit', day: '2-digit' };
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', options).replace(',', '');
        }

        async function fetchVehicleDetails(vehicleId) {
            const response = await fetch(`https://velriders.com/api/vehicle-details?vehicle_id=${vehicleId}`);
            const data = await response.json();
            if (data.status === "success") {
                const vehicle = data.data;
                document.querySelector('.periodoftime img').src = vehicle.cutout_image;
                document.querySelector('.info h3').innerText = vehicle.vehicle_name;
            } else {
                console.error('Failed to fetch vehicle details');
            }
        }

        let coupons = [];
        let initialFinalAmount = 0;
        let finalAmount = 0;
        let couponApplied = false;

        async function fetchCoupons(vehicleId) {
            const response = await fetch(`https://velriders.com/api/get-coupons?vehicle_id=${vehicleId}&start_date=2025-02-21T19:13:00&end_date=2025-02-27T18:13:00&unlimited_kms=0&total_price=${initialFinalAmount}`);
            const data = await response.json();
            if (data.status === "success") {
                coupons = data.data;
            }
        }


        function showConfetti() {
            const colors = ['#FFC700', '#FF3D00', '#FF6F00', '#FFAB00', '#FFEA00', '#00C853', '#00B0FF', '#D5006D', '#6200EA', '#FF4081'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.width = Math.random() * 10 + 5 + 'px';
                confetti.style.height = Math.random() * 10 + 5 + 'px';
                confetti.style.animationDuration = Math.random() * 1 + 1 + 's';
                document.body.appendChild(confetti);
                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }


        document.getElementById('applyCoupon').addEventListener('click', applyCoupon);
        document.getElementById('couponCode').addEventListener('keydown', function (event) {
            if (event.key === 'Enter') {
                applyCoupon();
            }
        });

        function applyCoupon() {
            const couponCode = document.getElementById('couponCode').value;
            const coupon = coupons.find(c => c.code === couponCode);

            if (couponApplied) {
                document.getElementById('couponMessage').innerHTML = '<h2>Coupon has already been applied!</h2>';
                return;
            }

            if (coupon) {
                let discount = 0;
                if (coupon.type === 'percentage') {
                    discount = (initialFinalAmount * coupon.percentage_discount) / 100;
                } else if (coupon.type === 'fixed') {
                    discount = parseFloat(coupon.fixed_discount_amount);
                }

                finalAmount = initialFinalAmount - discount;
                document.getElementById('couponMessage').innerHTML = `<h2>Coupon Applied! New Final Amount: ₹${finalAmount.toFixed(2)}</h2>`;
                document.querySelector('.final-amount').innerText = `₹${finalAmount.toFixed(2)}`;
                couponApplied = true;
                showConfetti();
            } else {
                document.getElementById('couponMessage').innerHTML = '<h2>Invalid Coupon Code</h2>';
            }
        }

        window.onload = async function () {

            const vehicleId = getUrlParameter('vehicle_id') || 'Unknown Vehicle';
            const fromDate = getUrlParameter('from_date') || '';
            const fromTime = getUrlParameter('from_time') || '';
            const toDate = getUrlParameter('to_date') || '';
            const toTime = getUrlParameter('to_time') || '';
            const totalPriceRaw = getUrlParameter('total_price') || '0';
            const cityName = getUrlParameter('city_name');

            const locationDropdown = document.querySelector('.location-dropdown select');
            if (locationDropdown && cityName) {
                const options = Array.from(locationDropdown.options);
                const selectedOption = options.find(option => option.value.toLowerCase() === cityName.toLowerCase());
                if (selectedOption) {
                    selectedOption.selected = true;
                }
            }


            initialFinalAmount = parseFloat(totalPriceRaw.replace(/,/g, '')) || 0;
            finalAmount = initialFinalAmount;
            const convenienceFee = 99;
            const taxRate = 0.18;
            const tripAmount = (initialFinalAmount - convenienceFee) / (1 + taxRate);
            const taxAmount = (tripAmount * taxRate).toFixed(2);
            const formattedFromDate = fromDate ? formatDate(`${fromDate}T${fromTime}`) : 'N/A';
            const formattedToDate = toDate ? formatDate(`${toDate}T${toTime}`) : 'N/A';


            document.querySelector('.info h3').innerText = `Vehicle ID: ${vehicleId}`;
            document.querySelector('.data .left h5').innerText = formattedFromDate;
            document.querySelector('.data .left p').innerText = fromTime || 'N/A';
            document.querySelector('.data .right h5').innerText = formattedToDate;
            document.querySelector('.data .right p').innerText = toTime || 'N/A';
            document.querySelector('.trip-amount').innerText = `₹${tripAmount.toFixed(2)}`;
            document.querySelector('.tax-amount').innerText = `₹${taxAmount}`;
            document.querySelector('.convenience-fee').innerText = `+₹${convenienceFee}`;
            document.querySelector('.total-price').innerText = `₹${(tripAmount + parseFloat(taxAmount)).toFixed(2)}`;
            document.querySelector('.final-amount').innerText = `₹${finalAmount.toFixed(2)}`;

            try {
                await Promise.all([fetchVehicleDetails(vehicleId), fetchCoupons(vehicleId)]);
                document.getElementById('loading-spinner').style.display = 'none';
                document.getElementById('main-content').style.display = 'block';
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('loading-spinner').innerHTML = '<div style="font-size: 24px; color: #FF0000;">Error loading data. Please try again.</div>';
            }
        };

        document.querySelector('.backbtn a').addEventListener('click', function (event) {
            event.preventDefault();
            const fromDate = document.querySelector('.data .left h5').innerText;
            const fromTime = document.querySelector('.data .left p').innerText;
            const toDate = document.querySelector('.data .right h5').innerText;
            const toTime = document.querySelector('.data .right p').innerText;
            const vehicleId = getUrlParameter('vehicle_id');
            const selectedCity = document.querySelector('.location-dropdown select').value;

            const redirectUrl = `index10.html?vehicle_id=${vehicleId}&from_date=${fromDate}&from_time=${fromTime}&to_date=${toDate}&to_time=${toTime}&city_name=${selectedCity}`;
            window.location.href = redirectUrl;
        });

        document.getElementById('pay-now-btn').addEventListener('click', function (e) {
            e.preventDefault();

            const userId = localStorage.getItem('userId');
            const token = localStorage.getItem('token');

            if (!userId || !token) {
                alert('You must be logged in to proceed with payment. Redirecting to login page...');
                window.location.href = 'index4.html';
                return
            }


            const finalAmountText = document.querySelector('.final-amount').innerText.replace('₹', '');
            const amountInPaise = Math.round(parseFloat(finalAmountText) * 100);

            const options = {
                key: 'rzp_test_0axpljWc7CaCN6',
                amount: amountInPaise,
                currency: 'INR',
                name: 'VelRiders',
                description: 'Vehicle Rental Payment',
                image: 'image1/logo.jpg',
                handler: async function (response) {
                    const bookingData = {
                        userId: userId,
                        vehicleId: getUrlParameter('vehicle_id'),
                        fromDate: document.querySelector('.data .left h5').innerText,
                        fromTime: document.querySelector('.data .left p').innerText,
                        toDate: document.querySelector('.data .right h5').innerText,
                        toTime: document.querySelector('.data .right p').innerText,
                        totalPrice: finalAmountText,
                        paymentId: response.razorpay_payment_id,
                        status: 'Confirmed'
                    };

                    try {
                        const bookingResponse = await fetch('http://localhost:3000/bookings', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${token}`
                            },
                            body: JSON.stringify(bookingData)
                        });

                        const bookingResult = await bookingResponse.json();
                        if (bookingResult.success) {
                            window.location.href = `booking.html?userId=${userId}`;
                        } else {
                            alert('Booking failed. Please try again.');
                        }
                    } catch (error) {
                        console.error('Error during booking:', error);
                        alert('An error occurred while processing your booking. Please try again.');
                    }
                },
                prefill: {
                    name: localStorage.getItem(`profileName_${userId}`) || 'Customer Name',
                    email: 'customer@example.com',
                    contact: '9737771018'
                },
                notes: {
                    vehicle_id: getUrlParameter('vehicle_id'),
                    booking_date: new Date().toISOString()
                },
                theme: { color: '#38A4A6' },
                modal: {
                    ondismiss: function () {
                        alert('Payment cancelled or dismissed.');
                    }
                }
            };

            const rzp = new Razorpay(options);
            rzp.open();

            rzp.on('payment.failed', async function (response) {
                const bookingData = {
                    userId: userId,
                    vehicleId: getUrlParameter('vehicle_id'),
                    fromDate: document.querySelector('.data .left h5').innerText,
                    fromTime: document.querySelector('.data .left p').innerText,
                    toDate: document.querySelector('.data .right h5').innerText,
                    toTime: document.querySelector('.data .right p').innerText,
                    totalPrice: finalAmountText,
                    paymentId: null,
                    status: 'Pending'
                };

                try {
                    await fetch('http://localhost:3000/bookings', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify(bookingData)
                    });
                    alert('Payment Failed! Error: ' + response.error.description);
                } catch (error) {
                    console.error('Error logging failed payment:', error);
                    alert('Payment failed and could not be logged. Please contact support.');
                }
            });
        });
    </script>
    <script src="profile.js"></script>
    <script src="script9.js"></script>
</body>

</html>